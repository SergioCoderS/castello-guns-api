#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from flask import Flask, jsonify, request
from flask_cors import CORS
import hashlib
import json
from datetime import datetime

app = Flask(__name__)
CORS(app)

# ============================================
# –ó–ê–•–ò–©–ï–ù–Ü –î–ê–ù–Ü (–¢—ñ–ª—å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ!)
# ============================================

RECIPES_DATA = {
    "ingots": {
        "–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": {"–í—É–≥—ñ–ª–ª—è": 5, "–ó–∞–ª—ñ–∑–Ω–∞ —Ä—É–¥–∞": 10, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–ó–ª–∏—Ç–æ–∫ –∑–æ–ª–æ—Ç–∞": {"–í—É–≥—ñ–ª–ª—è": 5, "–ó–æ–ª–æ—Ç–∞ —Ä—É–¥–∞": 10, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–ó–ª–∏—Ç–æ–∫ –ª–∞—Ç—É–Ω—ñ": {"–í—É–≥—ñ–ª–ª—è": 5, "–ó–ª–∏—Ç–æ–∫ –º—ñ–¥—ñ": 1, "–ó–ª–∏—Ç–æ–∫ —Ü–∏–Ω–∫—É": 1, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–ó–ª–∏—Ç–æ–∫ –º—ñ–¥—ñ": {"–í—É–≥—ñ–ª–ª—è": 5, "–ú—ñ–¥–Ω–∞ —Ä—É–¥–∞": 10, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–ó–ª–∏—Ç–æ–∫ —Å–≤–∏–Ω—Ü—é": {"–í—É–≥—ñ–ª–ª—è": 5, "–°–≤–∏–Ω—Ü–µ–≤–∞ —Ä—É–¥–∞": 10, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–ó–ª–∏—Ç–æ–∫ –°—Ä—ñ–±–ª–∞": {"–í—É–≥—ñ–ª–ª—è": 5, "–°—Ä—ñ–±–Ω–∞ —Ä—É–¥–∞": 10, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": {"–í—É–≥—ñ–ª–ª—è": 5, "–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 1, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–ó–ª–∏—Ç–æ–∫ —Ü–∏–Ω–∫—É": {"–í—É–≥—ñ–ª–ª—è": 5, "–¶–∏–Ω–∫–æ–≤–∞ —Ä—É–¥–∞": 1, "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 1},
        "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": {"–í—É–≥—ñ–ª–ª—è": 5, "–ì–ª–∏–Ω–∞": 5}
    },
    "parts": {
        "–ë–∞—Ä–∞–±–∞–Ω": {"–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 1},
        "–î—É–ª–æ": {"–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 1},
        "–ü—Ä—É–∂–∏–Ω–∞ 10—à—Ç": {"–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 1},
        "–®—É—Ä—É–ø 20—à—Ç": {"–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 1},
        "–ü—Ä—É–∂–∏–Ω–∞": {"–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 0.1},
        "–®—É—Ä—É–ø": {"–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 0.05},
        "–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": {"–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 2, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2, "–î–µ—Ä–µ–≤–æ": 10, "–®—É—Ä—É–ø": 10},
        "–ö–æ—Ä–ø—É—Å –ª–µ–≥–∫–æ—ó –∑–±—Ä–æ—ó": {"–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 1, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 1, "–î–µ—Ä–µ–≤–æ": 5, "–®—É—Ä—É–ø": 5}
    },
    "recipes": [
        {"id": 1, "name": "–†–µ–º–æ–Ω—Ç–Ω–∏–π –Ω–∞–±—ñ—Ä", "cat": "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏", "resources": {"–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 1, "–¢–∫–∞–Ω–∏–Ω–∞": 5, "–î–µ—Ä–µ–≤–æ": 1, "–®—É—Ä—É–ø": 5, "–ü—Ä—É–∂–∏–Ω–∞": 2}},
        {"id": 2, "name": "–ì–≤–∏–Ω—Ç—ñ–≤–∫–∞ Boltaction", "cat": "–ì–≤–∏–Ω—Ç—ñ–≤–∫–∞", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–î–µ—Ä–µ–≤–æ": 25, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 3, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 4}},
        {"id": 3, "name": "–ì–≤–∏–Ω—Ç—ñ–≤–∫–∞ Springfield", "cat": "–ì–≤–∏–Ω—Ç—ñ–≤–∫–∞", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–î–µ—Ä–µ–≤–æ": 20, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 3, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 4}},
        {"id": 4, "name": "–î—Ä–æ–±–æ–≤–∏–∫ Double Barrel", "cat": "–î—Ä–æ–±–æ–≤–∏–∫", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 2, "–î–µ—Ä–µ–≤–æ": 5, "–®—É—Ä—É–ø": 20, "–ü—Ä—É–∂–∏–Ω–∞": 2, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 3}},
        {"id": 5, "name": "–î—Ä–æ–±–æ–≤–∏–∫ Repeating", "cat": "–î—Ä–æ–±–æ–≤–∏–∫", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–î–µ—Ä–µ–≤–æ": 5, "–®—É—Ä—É–ø": 15, "–ü—Ä—É–∂–∏–Ω–∞": 2, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2}},
        {"id": 6, "name": "–î—Ä–æ–±–æ–≤–∏–∫ Semi-Auto", "cat": "–î—Ä–æ–±–æ–≤–∏–∫", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–î–µ—Ä–µ–≤–æ": 5, "–®—É—Ä—É–ø": 15, "–ü—Ä—É–∂–∏–Ω–∞": 2, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2, "–ó–ª–∏—Ç–æ–∫ –°—Ä—ñ–±–ª–∞": 2, "–ó–ª–∏—Ç–æ–∫ –∑–æ–ª–æ—Ç–∞": 2}},
        {"id": 7, "name": "–†–µ–≤–æ–ª—å–≤–µ—Ä Cattleman", "cat": "–†–µ–≤–æ–ª—å–≤–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –ª–µ–≥–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–ë–∞—Ä–∞–±–∞–Ω": 1, "–î–µ—Ä–µ–≤–æ": 1, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 3, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2}},
        {"id": 8, "name": "–†–µ–≤–æ–ª—å–≤–µ—Ä Double Action", "cat": "–†–µ–≤–æ–ª—å–≤–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –ª–µ–≥–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–ë–∞—Ä–∞–±–∞–Ω": 1, "–î–µ—Ä–µ–≤–æ": 1, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 3, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2}},
        {"id": 9, "name": "–†–µ–≤–æ–ª—å–≤–µ—Ä Double Action Gambler", "cat": "–†–µ–≤–æ–ª—å–≤–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –ª–µ–≥–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–ë–∞—Ä–∞–±–∞–Ω": 1, "–î–µ—Ä–µ–≤–æ": 1, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 3, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2}},
        {"id": 10, "name": "–†–µ–≤–æ–ª—å–≤–µ—Ä Lemat", "cat": "–†–µ–≤–æ–ª—å–≤–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –ª–µ–≥–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 2, "–ë–∞—Ä–∞–±–∞–Ω": 1, "–î–µ—Ä–µ–≤–æ": 1, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 4, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2}},
        {"id": 11, "name": "–†–µ–≤–æ–ª—å–≤–µ—Ä Navy", "cat": "–†–µ–≤–æ–ª—å–≤–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –ª–µ–≥–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–ë–∞—Ä–∞–±–∞–Ω": 1, "–î–µ—Ä–µ–≤–æ": 1, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 3, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 3, "–ó–ª–∏—Ç–æ–∫ –∑–æ–ª–æ—Ç–∞": 1, "–ó–ª–∏—Ç–æ–∫ –°—Ä—ñ–±–ª–∞": 1}},
        {"id": 12, "name": "–†–µ–≤–æ–ª—å–≤–µ—Ä Schofield", "cat": "–†–µ–≤–æ–ª—å–≤–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –ª–µ–≥–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–ë–∞—Ä–∞–±–∞–Ω": 1, "–î–µ—Ä–µ–≤–æ": 1, "–®—É—Ä—É–ø": 10, "–ü—Ä—É–∂–∏–Ω–∞": 3, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 2}},
        {"id": 13, "name": "–†—ñ–ø—ñ—Ç–µ—Ä Carbine", "cat": "–†—ñ–ø—ñ—Ç–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–î–µ—Ä–µ–≤–æ": 5, "–®—É—Ä—É–ø": 15, "–ü—Ä—É–∂–∏–Ω–∞": 4, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 3}},
        {"id": 14, "name": "–†—ñ–ø—ñ—Ç–µ—Ä Evans", "cat": "–†—ñ–ø—ñ—Ç–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 1, "–î–µ—Ä–µ–≤–æ": 10, "–®—É—Ä—É–ø": 15, "–ü—Ä—É–∂–∏–Ω–∞": 4, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 3}},
        {"id": 15, "name": "–†—ñ–ø—ñ—Ç–µ—Ä Lancaster", "cat": "–†—ñ–ø—ñ—Ç–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 2, "–î–µ—Ä–µ–≤–æ": 5, "–®—É—Ä—É–ø": 15, "–ü—Ä—É–∂–∏–Ω–∞": 4, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 3}},
        {"id": 16, "name": "–†—ñ–ø—ñ—Ç–µ—Ä Lichfield", "cat": "–†—ñ–ø—ñ—Ç–µ—Ä", "resources": {"–ö–æ—Ä–ø—É—Å –≤–∞–∂–∫–æ—ó –∑–±—Ä–æ—ó": 1, "–î—É–ª–æ": 2, "–î–µ—Ä–µ–≤–æ": 5, "–®—É—Ä—É–ø": 15, "–ü—Ä—É–∂–∏–Ω–∞": 4, "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 3}}
    ]
}

COST_PRICES = {
    "–ó–ª–∏—Ç–æ–∫ –∑–æ–ª–æ—Ç–∞": 200,
    "–ó–ª–∏—Ç–æ–∫ –°—Ä—ñ–±–ª–∞": 200,
    "–ó–ª–∏—Ç–æ–∫ –ª–∞—Ç—É–Ω—ñ": 65,
    "–ó–ª–∏—Ç–æ–∫ —Å—Ç–∞–ª—ñ": 35,
    "–ó–ª–∏—Ç–æ–∫ –∑–∞–ª—ñ–∑–∞": 25,
    "–ó–ª–∏—Ç–æ–∫ –º—ñ–¥—ñ": 25,
    "–ó–ª–∏—Ç–æ–∫ —Ü–∏–Ω–∫—É": 25,
    "–ó–ª–∏—Ç–æ–∫ —Å–≤–∏–Ω—Ü—é": 25,
    "–í—É–≥—ñ–ª–ª—è": 1.5,
    "–î–µ—Ä–µ–≤–æ": 0,
    "–ì–ª–∏–Ω–∞": 0,
    "–¢–∫–∞–Ω–∏–Ω–∞": 0,
    "–ó–∞–ª—ñ–∑–Ω–∞ —Ä—É–¥–∞": 0,
    "–ó–æ–ª–æ—Ç–∞ —Ä—É–¥–∞": 0,
    "–ú—ñ–¥–Ω–∞ —Ä—É–¥–∞": 0,
    "–°–≤–∏–Ω—Ü–µ–≤–∞ —Ä—É–¥–∞": 0,
    "–°—Ä—ñ–±–Ω–∞ —Ä—É–¥–∞": 0,
    "–¶–∏–Ω–∫–æ–≤–∞ —Ä—É–¥–∞": 0,
    "–§–æ—Ä–º–∞ –∑ –≥–ª–∏–Ω–∏": 5,
}

# –ë–µ–∑–ø–µ–∫–∞: –ü–∞—Ä–æ–ª—å –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ —Ö–µ—à
DEFAULT_PASSWORD_HASH = "ad3ca0d8024c8a3d5fe0c0947c9a4eb9d8c5f7a72e8b3c1f9d6e4a2b5c8f1"  # SHA-256 –≤—ñ–¥ 'castellllo'
AUTH_TOKEN = None

# ============================================
# API –†–û–£–¢–ò
# ============================================

@app.route('/api/auth', methods=['POST'])
def authenticate():
    """–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
    data = request.get_json()
    password = data.get('password', '')
    
    # –•–µ—à–∏—Ä—É—î–º–æ –≤–≤–µ–¥–µ–Ω–∏–π –ø–∞—Ä–æ–ª—å
    password_hash = hashlib.sha256(password.encode()).hexdigest()
    
    if password_hash == DEFAULT_PASSWORD_HASH:
        global AUTH_TOKEN
        AUTH_TOKEN = hashlib.sha256(f"{password}{datetime.now()}".encode()).hexdigest()
        return jsonify({"success": True, "token": AUTH_TOKEN})
    
    return jsonify({"success": False, "error": "–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å"}), 401

@app.route('/api/recipes', methods=['GET'])
def get_recipes():
    """–û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ —Ä–µ—Ü–µ–ø—Ç–∏"""
    token = request.headers.get('Authorization', '').replace('Bearer ', '')
    
    if not token or token != AUTH_TOKEN:
        return jsonify({"error": "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ"}), 401
    
    return jsonify(RECIPES_DATA)

@app.route('/api/prices', methods=['GET'])
def get_prices():
    """–û—Ç—Ä–∏–º–∞—Ç–∏ —Ü—ñ–Ω–∏"""
    token = request.headers.get('Authorization', '').replace('Bearer ', '')
    
    if not token or token != AUTH_TOKEN:
        return jsonify({"error": "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ"}), 401
    
    return jsonify(COST_PRICES)

@app.route('/api/health', methods=['GET'])
def health_check():
    """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É —Å–µ—Ä–≤–µ—Ä–∞"""
    return jsonify({"status": "ok", "timestamp": datetime.now().isoformat()})

# ============================================
# –ó–ê–ü–£–°–ö
# ============================================

if __name__ == '__main__':
    import os
    port = int(os.environ.get('PORT', 5000))
    debug = os.environ.get('FLASK_ENV') == 'development'
    
    print("üöÄ Flask —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ port", port)
    print("üìù API –¥–æ—Å—Ç—É–ø–Ω–∞")
    app.run(debug=debug, port=port, host='0.0.0.0')
